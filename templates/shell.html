{% extends 'content.html' %}
{% block h %}
    <!-- /. NAV SIDE  -->
    <div id="page-wrapper">
        <div class="header">
            <h3 class="page-header">
                服务器信息
            </h3>
        </div>
        <div id="panel panel-default">
            <div class="col-xs-6 col-md-3">
                <!-- Advanced Tables -->
                <div class="panel panel-default chartJs">
                    <div class="sub-title">Server List</div>
                    <ul id="treeDemo" class="ztree"></ul>
                </div>
            </div>

            <div class="col-xs-6 col-md-3">
                <div class="panel panel-default chartJs">
                    <div class="sub-title">Please Enter The Command</div>
                    <div>
                        <textarea id="cmd" class="form-control" rows="3"
                                  style="width: 95%;resize:vertical;margin: 6%"></textarea>
                    </div>
                    <div style="margin-left: 45%;color: #ff0006" class="title" id="status"><br></div>
                    <button type="button" class="btn btn-success" id="run"
                            style="margin-left: 45%;margin-top: 10px" data-toggle="modal" data-target="#myModal">
                        运行
                    </button>
                </div>
            </div>

            {#服务器模板#}
            <div class="col-xs-6 col-md-3">
                <div class="panel panel-default chartJs">
                    <div class="sub-title">Template</div>
                    <div class="modal-body">
                        <table class="table table-striped table-bordered table-hover" id="template">
                        </table>
                    </div>
                    <div style="font-size: 14px;color: #0b09ff;margin-left: 5%;">Tip: Double click table to use the
                        template
                    </div>
                    <button type="button" class="btn btn-success" id="addTemplate"
                            style="margin-left: 45%;margin-top: 10px" data-toggle="modal" data-target="#server">
                        添加
                    </button>
                </div>
            </div>
        </div>
        {#运行结果弹框#}
        <div class="modal fade bs-example-modal-lg" id="myModal" tabindex="-1" role="dialog"
             aria-labelledby="myModalLabel"
             aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                        <h4 class="modal-title" id="myModalLabel">Result</h4>
                    </div>
                    <div class="modal-body" style="height: 800px;overflow: auto;">
                        <table class="table table-striped table-bordered table-hover" id="table">
                        </table>
                    </div>
                </div>
            </div>
        </div>
        {#模板添加弹框#}
        <div class="modal fade" id="server" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
             aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                        <h4 class="modal-title" id="myModalLabel">ServerTemplate</h4>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="inputEmail3" class="col-sm-2 control-label"
                                   style="width: 25% ">TemplateName：</label>
                            <input type="text" name="user" class="form-control" maxlength="20"
                                   id="temp_name" autocomplete="off" style="width: 57%">
                        </div>
                        <div class="form-group">
                            <label for="inputEmail3" class="col-sm-2 control-label"
                                   style="width: 25% ">Command：</label>
                            <textarea id="temp_text" class="form-control" rows="10" cols="40"
                                      required></textarea>
                        </div>
                        <input type="hidden" id="temp_uid">
                        <button class="btn btn-default" id="temp_btn"
                                style="margin-left: 45%;color: #FFFFFF;background-color: #5cb85c;border-color: #4cae4c;  ">
                            添加
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
{% block js %}
    <link rel="stylesheet" href="/static/js/bootstrapStyle.css" type="text/css">
    <script type="text/javascript" src="/static/js/jquery-1.11.1.min.js"></script>
    <script type="text/javascript" src="/static/js/bootstrap.js"></script>
    <script src="/static/assets/js/dataTables/bootstrap-table.js"></script>
    <script type="text/javascript" src="/static/js/jquery.ztree.core.js"></script>
    <script type="text/javascript" src="/static/js/jquery.ztree.excheck.js"></script>
    <script type="text/javascript" src="/static/js/csrf.js"></script>
    <script type="text/javascript" src="/static/js/jquery-ui.js"></script>
    <script type="text/javascript">
        var setting = {
            view: {
                selectedMulti: false
            },
            check: {
                enable: true
            },
            data: {
                simpleData: {
                    enable: true
                }
            },
            edit: {
                enable: false
            }
        };
        $(document).ready(function () {
            $.ajax({
                url: "/tree/", success: function (results) {
                    var parsedJson = jQuery.parseJSON(results);
                    $.fn.zTree.init($("#treeDemo"), setting, parsedJson);
                }
            });
            $('#template').bootstrapTable({
                url: '/getTemplate/',
                method: 'get',
                sidePagination: 'client',   //谁来分页，客户端：'client'，服务端：'server'
                pageNumber: 1,   //默认显示 首页
                pageSize: 10,     //每页需要显示的数据量
                pageList: "[10, 25, 50, 100, All]", //可供选择的，每页需要显示的数据量
                sortable: false,
                columns: [{
                    field: 'name',
                    title: 'name',
                    sortable: true,
                    formatter: paramsMatter,
                }, {
                    width: 105,
                    field: 'content',
                    title: 'operation',
                    formatter: actionFormatter,
                }],
                responseHandler: function (data) {
                    return data.rows;
                },
                onDblClickRow: function (row) {
                    $('#cmd').val(row.content);
                }
            });
        });

        //提示框
        function paramsMatter(value, row, index) {
            var span = document.createElement('span');
            span.setAttribute('title', row.content);
            span.innerHTML = value;
            return span.outerHTML;
        }

        //操作框
        function actionFormatter(value, row, index) {
            let myArray = [];
            myArray[0] = row.uid;
            myArray[1] = row.name;
            myArray[2] = row.content;
            let result = "";
            result += '<button onclick=\"modify(\'' + row.uid + '\',\'' + row.name + '\',\'' + row.content + '\')" style="color:#fff;background-color:#409eff;border-color:#409eff;border-style:solid">编辑</button>';
            result += '<button onclick="del_template(' + row.uid + ')" style="color:#fff;background-color:#c20003;border-color:#c20006;border-style:solid">删除</button>';
            return result;
        }

        // 编辑模板
        function modify(uid, name, content) {
            $('#temp_name').val(name);
            $('#temp_text').val(content);
            $('#temp_uid').val(uid);
            $('#temp_btn').text('修改');
            $('#server').modal();
        }

        //删除模板
        function del_template(uid) {
            if (confirm("你确定要删除吗？")) {
                $.ajax(
                    {
                        url: "/delTemplate/",
                        data: {'uid': uid},
                        type: 'post',
                        dataType: 'json',
                        async: true,
                        success: function (data) {
                            alert(data.mes)
                            location.reload();
                        },
                        error: function (status, error) {
                            alert(error)
                        }
                    }
                )
            }
        }

        //添加模板，修改模板
        $('#temp_btn').click(function () {
            var temp_uid = $('#temp_uid').val();
            var temp_name = $('#temp_name').val();
            var temp_text = $('#temp_text').val();
            $.ajax(
                {
                    url: '/addTemplate/',
                    data: {'temp_name': temp_name, 'temp_text': temp_text, 'temp_uid': temp_uid},
                    type: 'post',
                    dataType: 'json',
                    async: 'true',
                    success: function (data) {
                        alert(data.mes)
                        location.reload();
                    },
                    error: function (status, error) {
                        alert(error)
                    }
                })
        });
        //弹框实现移动效果
        $('#server').draggable();
        $('#myModal').draggable();
    </script>
    <script>
        //-->
        $("#run").click(function () {
                var status = $("#status");
                var table = $('#table');
                status.text("运行中...");
                table.bootstrapTable('destroy');
                var treeObj = $.fn.zTree.getZTreeObj("treeDemo");
                nodes = treeObj.getCheckedNodes(true);
                var ids = [];
                for (var i = 0; i < nodes.length; i++) {
                    if (nodes[i].id >= 0) {
                        ids[ids.length] = nodes[i].id;
                    }
                }
                table.bootstrapTable({
                    url: '/linux/',
                    method: 'POST',
                    contentType: "application/x-www-form-urlencoded; charset=UTF-8",
                    cache: true,   //是否启用 数据缓存
                    sidePagination: 'client',   //谁来分页，客户端：'client'，服务端：'server'
                    pageNumber: 1,   //默认显示 首页
                    pageSize: 10,     //每页需要显示的数据量
                    pageList: "[10, 25, 50, 100, All]", //可供选择的，每页需要显示的数据量
                    queryParamsType: 'limit',
                    pagination: true,
                    responseHandler: function (data) {
                        return data;
                    },
                    queryParams: function (params) {
                        return {
                            //pageSize: params.limit, //每一页的数据行数，默认是上面设置的10(pageSize)
                            //pageNumber: params.offset / params.limit + 1, //当前页面,默认是上面设置的1(pageNumber)
                            cmd: $("#cmd").val(),
                            uid: JSON.stringify(ids),
                        }
                    },   //查询参数,
                    columns: [{
                        field: 'hostname',
                        title: 'hostname',
                        sortable: true
                    }, {
                        field: 'ip',
                        title: 'ip',
                        sortable: true
                    },
                        {
                            field: 'result',
                            title: 'result',
                            sortable: true
                        }],
                    onLoadSuccess: function () {
                        status.text("运行结束")
                    }, onLoadError: function () {
                        console.log("数据加载失败");
                        status.text("运行结束");
                    },
                });
            }
        );
    </script>
{% endblock %}